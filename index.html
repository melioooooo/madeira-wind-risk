<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Madeira Airport Wind Risk (LPMA)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Google Fonts for nicer typography -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Montserrat', Arial, sans-serif;
    background: linear-gradient(120deg, #a8e063 0%, #56ab2f 100%);
    color: #222;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    background: rgba(255,255,255,0.85);
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    padding: 32px 24px 18px 24px;
    margin-top: 40px;
    margin-bottom: 16px;
    width: 90%;
    max-width: 480px;
    text-align: center;
  }
  h1 {
    font-size: 2.3em;
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 0;
    margin-top: 0;
    letter-spacing: 1px;
  }
  h2 {
    font-size: 1.1em;
    font-weight: 400;
    color: #333;
    margin-top: 10px;
    margin-bottom: 0;
  }
  #liveTime {
    font-size: 1em;
    font-weight: 500;
    color: #388e3c;
    margin: 10px 0 0 0;
    letter-spacing: 1px;
    background: #e8f5e9;
    border-radius: 8px;
    display: inline-block;
    padding: 6px 14px;
  }
  .risk {
    font-size: 2.7em;
    font-weight: bold;
    padding: 18px 0;
    border-radius: 10px;
    width: 70%;
    margin: 25px auto 8px;
    display: block;
    transition: background 0.3s;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    letter-spacing: 2px;
  }
  .green { background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); color: #fff; }
  .orange { background: linear-gradient(90deg, #ffb347 0%, #ffcc80 100%); color: #fff; }
  .red { background: linear-gradient(90deg, #f85032 0%, #e73827 100%); color: #fff; }
  #details {
    margin-top: 10px;
    font-size: 1.1em;
    background: #fffde7;
    border-radius: 8px;
    padding: 8px 0;
    color: #795548;
    font-weight: 500;
    width: 90%;
    max-width: 350px;
    margin-left: auto;
    margin-right: auto;
    letter-spacing: 1px;
  }
  section {
    background: rgba(255,255,255,0.85);
    border-radius: 16px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    width: 90%;
    max-width: 480px;
    padding: 24px;
    margin-bottom: 24px;
    margin-top: 0;
    text-align: left;
  }
  h3 {
    font-size: 1.08em;
    margin-bottom: 8px;
    color: #388e3c;
    font-weight: 600;
    letter-spacing: 1px;
  }
  pre {
    background: #f1f8e9;
    padding: 12px;
    overflow-x: auto;
    border-radius: 10px;
    font-size: 1.05em;
    margin: 0 0 14px 0;
    color: #2e7d32;
    border: 1px solid #c5e1a5;
  }
  form {
    margin-top: 12px;
    margin-bottom: 0;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
    font-size: 1em;
  }
  input[type=email] {
    width: 80%;
    padding: 10px;
    margin-top: 8px;
    border-radius: 8px;
    border: 1px solid #c5e1a5;
    font-size: 1em;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type=email]:focus {
    border-color: #388e3c;
  }
  button {
    padding: 10px 22px;
    margin-top: 10px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
    color: #fff;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover {
    background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
  }
  #subMsg {
    margin-top:10px;
    font-size: 1em;
    color: #e65100;
    font-weight: 500;
  }
  @media (max-width: 600px) {
    header, section { max-width: 98vw; padding: 16px; }
    .risk, #details { width: 98vw; }
  }
</style>
</head>
<body>
<header>
  <h1>Madeira Airport Wind Risk</h1>
  <h2>LPMA – Runways 05 (049°) / 23 (229°)</h2>
  <div id="liveTime">Loading time...</div>
  <p style="margin-top:15px;margin-bottom:0;color:#555;font-size:1.06em;">Typical August wind: <span style="background:#e0f7fa;border-radius:6px;padding:2px 8px;">11–13 kt (17–23 km/h)</span></p>
</header>

<div id="risk" class="risk">Loading...</div>
<p id="details"></p>

<section>
  <h3>Current METAR</h3>
  <pre id="metar">Loading...</pre>

  <h3>Current TAF</h3>
  <pre id="taf">Loading...</pre>
</section>

<section>
  <form id="subscribeForm" onsubmit="submitForm(event)">
    <label for="email">Get alerted when wind risk is <span style="color:#F44336;font-weight:700;">RED</span> (LPMA):</label>
    <input id="email" name="email" type="email" required placeholder="you@example.com" />
    <button type="submit">Subscribe</button>
    <div id="subMsg"></div>
  </form>
</section>

<script>
const API_KEY = "9a36222e800046f5bc2442dad1f47868"; // Replace with your CheckWX API key
const RUNWAYS = [49, 229]; // Corrected runway headings
const webAppUrl = "https://script.google.com/macros/s/AKfycbwrilEHTfBVNyGCbTCeoQGvuw8LP6e8KybS2r5uJZsuB6jYHdfFEfQY_DeAEibw72hI/exec"; // Replace with your Web App URL

function deg2rad(deg) { return deg * Math.PI / 180; }

function calcCrosswind(windDir, windSpeed, rwyHeading) {
  let angle = Math.abs(windDir - rwyHeading);
  if (angle > 180) angle = 360 - angle;
  return Math.round(windSpeed * Math.sin(deg2rad(angle)));
}

function getRisk(cross, gust) {
  if (cross > 25 || gust > 35) return "red";
  if (cross > 15 || gust > 25) return "orange";
  return "green";
}

async function fetchData() {
  try {
    let metarRes = await fetch(`https://api.checkwx.com/metar/LPMA?x-api-key=${API_KEY}`);
    let tafRes = await fetch(`https://api.checkwx.com/taf/LPMA?x-api-key=${API_KEY}`);
    let metarData = await metarRes.json();
    let tafData = await tafRes.json();

    let metar = metarData.data && metarData.data[0] ? metarData.data[0] : "No METAR data";
    let taf = tafData.data && tafData.data[0] ? tafData.data[0] : "No TAF data";
    
    document.getElementById("metar").textContent = metar;
    document.getElementById("taf").textContent = taf;

    let match = typeof metar === "string" ? metar.match(/(\d{3})(\d{2})G?(\d{2})?KT/) : null;
    if (match) {
      let dir = parseInt(match[1]);
      let spd = parseInt(match[2]);
      let gust = match[3] ? parseInt(match[3]) : spd;

      let crosswinds = RUNWAYS.map(r => calcCrosswind(dir, spd, r));
      let maxCross = Math.max(...crosswinds);

      let risk = getRisk(maxCross, gust);
      document.getElementById("risk").textContent = risk.toUpperCase();
      document.getElementById("risk").className = `risk ${risk}`;
      document.getElementById("details").textContent = 
        `Wind ${dir}° at ${spd} kt (gust ${gust} kt) | Max crosswind: ${maxCross} kt`;
    } else {
      document.getElementById("risk").textContent = "No wind data";
      document.getElementById("risk").className = "risk";
      document.getElementById("details").textContent = "";
    }
  } catch (err) {
    document.getElementById("risk").textContent = "Error loading data";
    document.getElementById("risk").className = "risk";
    document.getElementById("details").textContent = "";
    console.error(err);
  }
}

async function submitForm(e){
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  const payload = { email: email };
  try {
    const resp = await fetch(webAppUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await resp.json();
    document.getElementById('subMsg').textContent = j.message || (j.success ? "Subscribed" : "Error");
  } catch(err) {
    document.getElementById('subMsg').textContent = "Error sending request.";
  }
}

// Live time updater
function updateLiveTime() {
  // Use UTC for consistency (can switch to local if desired)
  const now = new Date();
  // Format: YYYY-MM-DD HH:mm:ss (UTC)
  const utc = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
  document.getElementById('liveTime').textContent = utc;
}
setInterval(updateLiveTime, 1000);
updateLiveTime();

fetchData();
setInterval(fetchData, 300000); // Refresh every 5 min
</script>
</body>
</html>
